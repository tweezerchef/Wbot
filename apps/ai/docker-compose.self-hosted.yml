# ============================================================================
# Self-Hosted LangGraph Deployment
# ============================================================================
# Docker Compose configuration for running LangGraph with:
# - External PostgreSQL (Supabase) for checkpoint persistence
# - Local Redis for pub/sub and caching
# - LangSmith integration for observability
#
# Usage:
#   1. Build the image:
#      langgraph build -t wbot-ai:latest
#
#   2. Start the services:
#      docker-compose -f docker-compose.self-hosted.yml up -d
#
#   3. Stop the services:
#      docker-compose -f docker-compose.self-hosted.yml down
#
# Environment variables (set in root ../../.env):
#   - DATABASE_URI: Full Postgres connection string from Supabase
#   - SUPABASE_URL: Your Supabase project URL
#   - SUPABASE_SERVICE_KEY: Service role key for auth
#   - ANTHROPIC_API_KEY: Claude API key
#   - LANGSMITH_API_KEY: (Optional) LangSmith API key for tracing
# ============================================================================

volumes:
  redis-data:
    driver: local

networks:
  default:
    driver: bridge
    enable_ipv6: true
    ipam:
      config:
        - subnet: 172.28.0.0/16
        - subnet: "fd00:db8::/64"

services:
  # ---------------------------------------------------------------------------
  # Redis - Required for LangGraph pub/sub and caching
  # ---------------------------------------------------------------------------
  langgraph-redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    # Not exposed externally - only accessible to langgraph-api

  # ---------------------------------------------------------------------------
  # LangGraph API Server
  # ---------------------------------------------------------------------------
  langgraph-api:
    image: ${IMAGE_NAME:-wbot-ai:latest}
    restart: unless-stopped
    ports:
      - "8123:8000"
    depends_on:
      langgraph-redis:
        condition: service_healthy
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    env_file:
      - ../../.env
    environment:
      # Database: Use Supabase PostgreSQL (external)
      # Set DATABASE_URI in your root .env file
      # Get it from: Supabase Dashboard > Settings > Database > Connection string (URI format)
      DATABASE_URI: ${DATABASE_URI}

      # Redis: Local service for pub/sub (overrides any .env REDIS_URL)
      REDIS_URI: redis://langgraph-redis:6379

      # LangSmith: Enable tracing (optional but recommended)
      LANGSMITH_TRACING: ${LANGSMITH_TRACING:-true}
      LANGSMITH_API_KEY: ${LANGSMITH_API_KEY}
      LANGSMITH_PROJECT: ${LANGSMITH_PROJECT:-wbot-wellness}

      # Connection pool settings
      LANGGRAPH_POSTGRES_POOL_MAX_SIZE: 50
