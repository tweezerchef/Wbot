name: AI Documentation

on:
  # Run on PRs that modify source files
  pull_request:
    paths:
      - 'apps/ai/src/**/*.py'
      - 'apps/web/src/**/*.ts'
      - 'apps/web/src/**/*.tsx'
      - 'supabase/migrations/**/*.sql'
      - 'database/migrations/**/*.sql'

  # Run on push to main
  push:
    branches:
      - main
    paths:
      - 'apps/ai/src/**/*.py'
      - 'apps/web/src/**/*.ts'
      - 'apps/web/src/**/*.tsx'
      - 'supabase/migrations/**/*.sql'
      - 'database/migrations/**/*.sql'

  # Weekly staleness check
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9 AM UTC

  # Manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Generation mode'
        required: true
        default: 'stale'
        type: choice
        options:
          - stale
          - full
          - check-only

permissions:
  contents: write      # Required for git push
  pull-requests: write # Required for gh pr create

jobs:
  check-docs:
    name: Check Documentation Staleness
    runs-on: ubuntu-latest
    outputs:
      has_stale: ${{ steps.staleness.outputs.has_stale }}
      has_missing: ${{ steps.staleness.outputs.has_missing }}
      needs_update: ${{ steps.staleness.outputs.needs_update }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git timestamps

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install anthropic python-dotenv

      - name: Check staleness
        id: staleness
        run: |
          python scripts/ai_docs/staleness.py --json > staleness.json || true

          # Count stale docs
          STALE_COUNT=$(cat staleness.json | python -c "import sys, json; data=json.load(sys.stdin); print(sum(1 for d in data if d['is_stale']))")

          # Count missing docs (docs that don't exist yet)
          MISSING_COUNT=$(cat staleness.json | python -c "import sys, json; data=json.load(sys.stdin); print(sum(1 for d in data if d.get('reason', '').startswith('Documentation file does not exist')))")

          echo "stale_count=$STALE_COUNT" >> $GITHUB_OUTPUT
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "has_stale=$([[ $STALE_COUNT -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_missing=$([[ $MISSING_COUNT -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "needs_update=$([[ $STALE_COUNT -gt 0 || $MISSING_COUNT -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

          # Pretty print for logs (|| true because script exits 1 when stale docs found)
          python scripts/ai_docs/staleness.py --verbose || true

      - name: Upload staleness report
        uses: actions/upload-artifact@v4
        with:
          name: staleness-report
          path: staleness.json

  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: check-docs
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode != 'check-only') ||
      (github.event_name == 'schedule' && needs.check-docs.outputs.needs_update == 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install anthropic python-dotenv

      - name: Download staleness report
        uses: actions/download-artifact@v4
        with:
          name: staleness-report

      - name: Determine generation mode
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          else
            # For push and schedule events, use stale mode to process only stale docs
            echo "mode=stale" >> $GITHUB_OUTPUT
          fi

      - name: Generate documentation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [[ "${{ steps.mode.outputs.mode }}" == "full" ]]; then
            python scripts/ai_docs/generator.py --full
          elif [[ "${{ steps.mode.outputs.mode }}" == "stale" ]]; then
            python scripts/ai_docs/generator.py --stale staleness.json
          else
            python scripts/ai_docs/generator.py
          fi

      - name: Check for changes
        id: changes
        run: |
          git add docs/
          if git diff --cached --quiet docs/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Count new vs modified files
            NEW_FILES=$(git diff --cached --name-only --diff-filter=A docs/ | wc -l | tr -d ' ')
            MODIFIED_FILES=$(git diff --cached --name-only --diff-filter=M docs/ | wc -l | tr -d ' ')
            echo "new_files=$NEW_FILES" >> $GITHUB_OUTPUT
            echo "modified_files=$MODIFIED_FILES" >> $GITHUB_OUTPUT
          fi

      # Direct commit for push to main
      - name: Commit documentation updates (push)
        if: steps.changes.outputs.has_changes == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "docs: auto-update documentation [skip ci]"
          git push

      # Create PR for scheduled runs or manual workflow dispatch
      - name: Create Pull Request (scheduled/manual)
        if: steps.changes.outputs.has_changes == 'true' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="docs/auto-update-$(date +%Y%m%d-%H%M%S)"

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git checkout -b "$BRANCH_NAME"
          git commit -m "docs: auto-update documentation"
          git push -u origin "$BRANCH_NAME"

          # Build PR body with details
          PR_BODY="## Automated Documentation Update

          This PR was automatically generated by the AI Documentation workflow.

          ### Changes
          - **New documentation files:** ${{ steps.changes.outputs.new_files || 0 }}
          - **Updated documentation files:** ${{ steps.changes.outputs.modified_files || 0 }}

          ### Trigger
          - **Event:** ${{ github.event_name }}
          - **Mode:** ${{ steps.mode.outputs.mode }}

          ### Review Checklist
          - [ ] Documentation is accurate and up-to-date
          - [ ] Code examples are correct
          - [ ] No sensitive information was exposed

          ---
          *Generated automatically by the [AI Documentation workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

          gh pr create \
            --title "docs: auto-update documentation ($(date +%Y-%m-%d))" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "documentation" \
            --label "automated"

  pr-comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: check-docs
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download staleness report
        uses: actions/download-artifact@v4
        with:
          name: staleness-report

      - name: Generate PR comment
        id: comment
        run: |
          python -c "
          import sys, json

          with open('staleness.json') as f:
              data = json.load(f)

          stale = [d for d in data if d['is_stale']]
          missing = [d for d in stale if d.get('reason', '').startswith('Documentation file does not exist')]
          outdated = [d for d in stale if d not in missing]

          if not stale:
              print('has_comment=false')
              sys.exit(0)

          print('has_comment=true')

          with open('comment.md', 'w') as f:
              f.write('## ðŸ“š Documentation Status\n\n')
              f.write('This PR modifies source files that have associated documentation.\n\n')

              if missing:
                  f.write(f'### ðŸ†• Missing Documentation ({len(missing)} files)\n')
                  f.write('These source files need new documentation:\n\n')
                  for d in missing:
                      f.write(f\"- \`{d['doc_path']}\`\n\")
                  f.write('\n')

              if outdated:
                  f.write(f'### âš ï¸ Outdated Documentation ({len(outdated)} files)\n')
                  f.write('These docs may need updating:\n\n')
                  for d in outdated:
                      f.write(f\"- \`{d['doc_path']}\` - {d['reason']}\n\")
                  f.write('\n')

              f.write('---\n')
              f.write('ðŸ’¡ **Tip:** Documentation will be auto-updated when merged to main, ')
              f.write('or you can manually trigger the [AI Documentation workflow](../../actions/workflows/ai-docs.yml).\n')
          " >> $GITHUB_OUTPUT

      - name: Post PR comment
        if: steps.comment.outputs.has_comment == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
