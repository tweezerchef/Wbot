name: AI Documentation

on:
  # Run on PRs that modify source files
  pull_request:
    paths:
      - 'apps/ai/src/**/*.py'
      - 'apps/web/src/**/*.ts'
      - 'apps/web/src/**/*.tsx'
      - 'supabase/migrations/**/*.sql'
      - 'database/migrations/**/*.sql'

  # Run on push to main
  push:
    branches:
      - main
    paths:
      - 'apps/ai/src/**/*.py'
      - 'apps/web/src/**/*.ts'
      - 'apps/web/src/**/*.tsx'
      - 'supabase/migrations/**/*.sql'
      - 'database/migrations/**/*.sql'

  # Weekly staleness check
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 9 AM UTC

  # Manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Generation mode'
        required: true
        default: 'changed'
        type: choice
        options:
          - changed
          - full
          - check-only

jobs:
  check-docs:
    name: Check Documentation Staleness
    runs-on: ubuntu-latest
    outputs:
      has_stale: ${{ steps.staleness.outputs.has_stale }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git timestamps

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install anthropic

      - name: Check staleness
        id: staleness
        run: |
          python scripts/ai_docs/staleness.py --json > staleness.json || true
          STALE_COUNT=$(cat staleness.json | python -c "import sys, json; data=json.load(sys.stdin); print(sum(1 for d in data if d['is_stale']))")
          echo "stale_count=$STALE_COUNT" >> $GITHUB_OUTPUT
          echo "has_stale=$([[ $STALE_COUNT -gt 0 ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

          # Pretty print for logs
          python scripts/ai_docs/staleness.py --verbose

      - name: Upload staleness report
        uses: actions/upload-artifact@v4
        with:
          name: staleness-report
          path: staleness.json

  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: check-docs
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode != 'check-only') ||
      (github.event_name == 'schedule' && needs.check-docs.outputs.has_stale == 'true')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install anthropic

      - name: Determine generation mode
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "mode=full" >> $GITHUB_OUTPUT
          else
            echo "mode=changed" >> $GITHUB_OUTPUT
          fi

      - name: Generate documentation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [[ "${{ steps.mode.outputs.mode }}" == "full" ]]; then
            python scripts/ai_docs/generator.py --full
          else
            python scripts/ai_docs/generator.py
          fi

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet docs/ || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Commit documentation updates
        if: steps.changes.outputs.has_changes == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/
          git commit -m "docs: auto-update documentation [skip ci]"
          git push

  pr-comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: check-docs
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download staleness report
        uses: actions/download-artifact@v4
        with:
          name: staleness-report

      - name: Generate PR comment
        id: comment
        run: |
          STALE_COUNT=$(cat staleness.json | python -c "import sys, json; data=json.load(sys.stdin); print(sum(1 for d in data if d['is_stale']))")

          if [[ $STALE_COUNT -gt 0 ]]; then
            echo "## Documentation Status" > comment.md
            echo "" >> comment.md
            echo "This PR modifies source files that have associated documentation." >> comment.md
            echo "" >> comment.md
            echo "**$STALE_COUNT documentation file(s) may need updating:**" >> comment.md
            echo "" >> comment.md
            
            cat staleness.json | python -c "
          import sys, json
          data = json.load(sys.stdin)
          for d in data:
              if d['is_stale']:
                  print(f\"- \`{d['doc_path']}\` - {d['reason']}\")
          "  >> comment.md
            
            echo "" >> comment.md
            echo "Consider updating the documentation before merging." >> comment.md
            echo "has_comment=true" >> $GITHUB_OUTPUT
          else
            echo "has_comment=false" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        if: steps.comment.outputs.has_comment == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
