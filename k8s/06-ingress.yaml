---
# Ingress for external access
# Routes traffic to web frontend and AI backend
# Requires an Ingress Controller (nginx, traefik, etc.)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: wbot-ingress
  namespace: wbot
  labels:
    app.kubernetes.io/name: wbot-ingress
    app.kubernetes.io/part-of: wbot
  annotations:
    # NGINX Ingress Controller annotations
    nginx.ingress.kubernetes.io/ssl-redirect: 'true'
    nginx.ingress.kubernetes.io/force-ssl-redirect: 'true'

    # Enable CORS for API endpoints
    nginx.ingress.kubernetes.io/enable-cors: 'true'
    nginx.ingress.kubernetes.io/cors-allow-methods: 'GET, POST, PUT, DELETE, OPTIONS'
    nginx.ingress.kubernetes.io/cors-allow-origin: '*'
    nginx.ingress.kubernetes.io/cors-allow-credentials: 'true'

    # Timeout settings for SSE streaming
    nginx.ingress.kubernetes.io/proxy-read-timeout: '3600'
    nginx.ingress.kubernetes.io/proxy-send-timeout: '3600'

    # Let's Encrypt certificate (if using cert-manager)
    cert-manager.io/cluster-issuer: 'letsencrypt-prod'

    # Rate limiting (adjust as needed)
    nginx.ingress.kubernetes.io/limit-rps: '10'
spec:
  ingressClassName: nginx # Change based on your ingress controller

  tls:
    - hosts:
        - wbot.example.com # Replace with your domain
      secretName: wbot-tls-cert

  rules:
    - host: wbot.example.com # Replace with your domain
      http:
        paths:
          # API Backend routes
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: wbot-ai
                port:
                  number: 8000

          # Health check route
          - path: /health
            pathType: Prefix
            backend:
              service:
                name: wbot-ai
                port:
                  number: 8000

          # Frontend routes (catch-all)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: wbot-web
                port:
                  number: 80

---
# Alternative: LoadBalancer Service (for cloud providers)
# Uncomment if you want direct LoadBalancer access instead of Ingress
#
# apiVersion: v1
# kind: Service
# metadata:
#   name: wbot-loadbalancer
#   namespace: wbot
# spec:
#   type: LoadBalancer
#   ports:
#   - port: 80
#     targetPort: 3000
#     name: http
#   - port: 8000
#     targetPort: 8000
#     name: api
#   selector:
#     app.kubernetes.io/part-of: wbot
